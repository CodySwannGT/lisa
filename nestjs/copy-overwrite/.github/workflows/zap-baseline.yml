# This file is managed by Lisa.
# Do not edit directly â€” changes will be overwritten on the next `lisa` run.

name: ZAP Baseline Scan (NestJS)

on:
  workflow_call:
    inputs:
      node_version:
        description: 'Node.js version to use'
        required: false
        default: '22.21.1'
        type: string
      package_manager:
        description: 'Package manager to use (npm, yarn, or bun)'
        required: false
        default: 'bun'
        type: string
      zap_target_url:
        description: 'Override URL for ZAP to scan (default: http://localhost:3000/graphql)'
        required: false
        default: 'http://localhost:3000/graphql'
        type: string
      zap_rules_file:
        description: 'Path to ZAP rules configuration file'
        required: false
        default: '.zap/baseline.conf'
        type: string

jobs:
  zap_baseline:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ inputs.package_manager != 'bun' && inputs.package_manager || '' }}

      - name: Setup Bun
        if: inputs.package_manager == 'bun'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.8'

      - name: Install dependencies
        run: |
          if [ "${{ inputs.package_manager }}" = "npm" ]; then
            npm ci
          elif [ "${{ inputs.package_manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          elif [ "${{ inputs.package_manager }}" = "bun" ]; then
            bun install --frozen-lockfile
          fi

      - name: Build project
        run: ${{ inputs.package_manager }} run build

      - name: Start NestJS server
        run: |
          ${{ inputs.package_manager }} run start &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        env:
          NODE_ENV: test
          PORT: 3000

      - name: Wait for server ready
        run: |
          echo "Waiting for NestJS server to be ready..."
          RETRIES=30
          until curl -sf http://localhost:3000/health > /dev/null 2>&1 || [ $RETRIES -eq 0 ]; do
            echo "Waiting for server... ($RETRIES retries left)"
            RETRIES=$((RETRIES - 1))
            sleep 2
          done
          if [ $RETRIES -eq 0 ]; then
            echo "Server failed to start within timeout"
            exit 1
          fi
          echo "Server is ready"

      - name: Check for ZAP rules file
        id: check_rules
        run: |
          if [ -f "${{ inputs.zap_rules_file }}" ]; then
            echo "has_rules=true" >> $GITHUB_OUTPUT
          else
            echo "has_rules=false" >> $GITHUB_OUTPUT
          fi

      - name: Run ZAP baseline scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: ${{ inputs.zap_target_url }}
          rules_file_name: ${{ steps.check_rules.outputs.has_rules == 'true' && inputs.zap_rules_file || '' }}
          fail_action: true
          allow_issue_writing: false
          artifact_name: 'zap-report-nestjs'

      - name: Stop NestJS server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill "$SERVER_PID" 2>/dev/null || true
          fi

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-baseline-report-nestjs-${{ github.run_id }}
          path: |
            zap-report.html
            zap-report.json
            zap-report.md
          retention-days: 14
